name: Release
description: ""
inputs:
  amd64Digests:
    description: ""
    required: true
  arm64Digests:
    description: ""
    required: true
  dockerHubUsername:
    description: ""
    required: true
  dockerHubToken:
    description: ""
    required: true
runs:
  using: composite
  steps:
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ inputs.dockerHubUsername }}
        password: ${{ inputs.dockerHubToken }}

    - shell: bash
      run: chmod +r ~/.docker/config.json

    - name: Push multi-arch manifests
      shell: bash
      env:
        AMD64_DIGESTS: ${{ inputs.amd64Digests }}
        ARM64_DIGESTS: ${{ inputs.arm64Digests }}
        IMAGE_TAG: dev-${{ github.sha }}
      run: |-
        ./release.sh push_multi_arch_manifest \
          docker.io/shopstic/iac-version-bumper "${IMAGE_TAG}" \
          "$(printenv AMD64_DIGESTS | jq -r '.iac_version_bumper')" \
          "$(printenv ARM64_DIGESTS | jq -r '.iac_version_bumper')"

        ./release.sh push_multi_arch_manifest \
          docker.io/shopstic/fdb-server "${IMAGE_TAG}" \
          "$(printenv AMD64_DIGESTS | jq -r '.fdb_server')" \
          "$(printenv ARM64_DIGESTS | jq -r '.fdb_server')"

        ./release.sh push_multi_arch_manifest \
          docker.io/shopstic/fdb-configurator "${IMAGE_TAG}" \
          "$(printenv AMD64_DIGESTS | jq -r '.fdb_configurator')" \
          "$(printenv ARM64_DIGESTS | jq -r '.fdb_configurator')"
